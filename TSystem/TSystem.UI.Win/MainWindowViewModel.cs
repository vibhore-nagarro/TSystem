using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Text;
using System.Windows;
using System.Windows.Threading;
using TSystem.Core;
using TSystem.Core.Events;
using TSystem.Entities;
using TSystem.Entities.Enums;

namespace TSystem.UI.Win
{
    public class Analysis
    {
        public Signal Signal { get; set; }
        public decimal TradePL { get; set; }
        public decimal PL { get; set; }
    }

    public class MainWindowViewModel : INotifyPropertyChanged
    {
        public event PropertyChangedEventHandler PropertyChanged;
        private void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }

        public ObservableCollection<Signal> Signals { get; set; } = new ObservableCollection<Signal>();
        public ObservableCollection<Candle> Candles { get; set; } = new ObservableCollection<Candle>();
        public ObservableCollection<Candle> HeikinAshi { get; set; } = new ObservableCollection<Candle>();

        AnalysisManager analysisManager = new AnalysisManager();
        public void OnLoad()
        {
            analysisManager.CandleCreated += AnalysisManager_CandleCreated;
            analysisManager.SignalCreated += AnalysisManager_SignalCreated;
            analysisManager.Start();
            
            //LoadData();

            //Analyzer analyzer = new Analyzer(715267);

            ////IEnumerable<string> quotes = File.ReadAllLines(@"D:\StockData\Nifty 50.csv").Skip(1);
            ////IEnumerable<string> quotes = File.ReadAllLines(@"D:\StockData\USD_INR Aug.csv").Skip(1).Reverse();
            ////foreach (string quote in quotes)
            //var candles = LoadData();
            //candles.RemoveAll(x => x.TimeStamp.Month < 3 || x.TimeStamp.Year == 2019);
            //foreach (Candle candle in candles)
            //{
            //    //string[] fields = quote.Split(',');
            //    //DateTime timeStamp = DateTime.ParseExact(fields[0], "MMM dd yyyy", null);
            //    //decimal close = decimal.Parse(fields[1].Trim('\"'));
            //    //decimal open = decimal.Parse(fields[2].Trim('\"'));
            //    //decimal high = decimal.Parse(fields[3].Trim('\"'));
            //    //decimal low = decimal.Parse(fields[4].Trim('\"'));

            //    //Candle candle = new Candle()
            //    //{
            //    //    Open = open,
            //    //    High = high,
            //    //    Low = low,
            //    //    Close = close,
            //    //    TimeStamp = timeStamp
            //    //};
            //    analyzer.Model.LTP = candle.Close;
            //    candle.Index = (uint)analyzer.Model.Candles.Count;
            //    analyzer.Model.Candles.Add(candle);
            //    analyzer.BuildHekinAshiCandle();

            //    Signal signal = analyzer.BackTest();
            //    if (signal.SignalType != SignalType.None)
            //    {
            //        Signals.Add(new Analysis()
            //        {
            //            Signal = signal,
            //            TradePL = Portfolio.Instance.PnL - ppl,
            //            PL = Portfolio.Instance.PnL,
            //        });
            //        ppl = Portfolio.Instance.PnL;
            //    }
            //}
            //analyzer.DumpOutput();
        }

        private void AnalysisManager_SignalCreated(object sender, EventArgs e)
        {
            Application.Current.Dispatcher.Invoke(() =>
            {
                Signals.Add(analysisManager.analyzer.Model.Signals.Last());
            });
        }

        private void AnalysisManager_CandleCreated(object sender, EventArgs e)
        {
            Application.Current.Dispatcher.Invoke(() =>
            {
                Candles.Add(analysisManager.analyzer.Model.Candles.Last());
                HeikinAshi.Add(analysisManager.analyzer.Model.HeikinAshi.Last());
            });            
        }

        private List<Candle> LoadData()
        
        {
            string response = @"{ 'candles':[['2019-09-26T00:00:00+0530',73.8,73.8,73.8,73.8,1,1],['2019-09-27T00:00:00+0530',73.8,73.85,73.5,73.5,225,212],['2019-09-30T00:00:00+0530',73.5,73.8,73.3,73.8,621,787],['2019-10-01T00:00:00+0530',73.7,73.9725,73.63,73.91,1154,1860],['2019-10-03T00:00:00+0530',74.0025,74.1,73.7125,73.73,164,1905],['2019-10-04T00:00:00+0530',73.7,73.8,73.6,73.7575,47,1889],['2019-10-07T00:00:00+0530',73.85,73.85,73.7025,73.7325,54,1929],['2019-10-09T00:00:00+0530',73.9,73.9475,73.6525,73.7275,155,2040],['2019-10-10T00:00:00+0530',73.65,73.875,73.65,73.8525,40,2060],['2019-10-11T00:00:00+0530',73.55,73.8,73.55,73.785,144,2092],['2019-10-14T00:00:00+0530',73.5,73.9,73.5,73.89,1322,3194],['2019-10-15T00:00:00+0530',73.88,74.1875,73.88,74.1625,1158,4242],['2019-10-16T00:00:00+0530',74.23,74.31,74.0525,74.13,1104,4565],['2019-10-17T00:00:00+0530',74.1125,74.1125,73.8,73.81,681,4133],['2019-10-18T00:00:00+0530',73.78,73.91,73.7,73.7775,304,3936],['2019-10-22T00:00:00+0530',73.0825,73.6,73.0825,73.5725,930,4057],['2019-10-23T00:00:00+0530',73.615,73.615,73.47,73.4825,226,4221],['2019-10-24T00:00:00+0530',73.3725,73.6,73.3725,73.545,162,4276],['2019-10-25T00:00:00+0530',73.55,73.56,73.35,73.4,926,5046],['2019-10-27T00:00:00+0530',73.35,73.415,73.35,73.41,6,5045],['2019-10-29T00:00:00+0530',73.2,73.3575,73.13,73.3075,425,5161],['2019-10-30T00:00:00+0530',73.2725,73.5,72.4,73.3175,126,5198],['2019-10-31T00:00:00+0530',73.16,73.51,73.16,73.4425,402,5189],['2019-11-01T00:00:00+0530',73.4,73.4,73.3025,73.3425,207,5333],['2019-11-04T00:00:00+0530',73.15,73.38,73.15,73.38,117,5309],['2019-11-05T00:00:00+0530',73.3,73.3,73.21,73.25,4,5308],['2019-11-06T00:00:00+0530',73.35,73.45,73.3125,73.44,42,5335],['2019-11-07T00:00:00+0530',73.55,73.55,73.35,73.39,13,5337],['2019-11-08T00:00:00+0530',73.5925,73.655,73.5675,73.5825,454,5643],['2019-11-11T00:00:00+0530',72.15,73.8,72.15,73.78,319,5722],['2019-11-13T00:00:00+0530',74,74.36,73.86,74.35,1307,6169],['2019-11-14T00:00:00+0530',74.36,74.45,74.0425,74.23,236,6175],['2019-11-15T00:00:00+0530',74.0675,74.1325,73.98,74.125,235,6181],['2019-11-18T00:00:00+0530',73.9,74.1,73.8725,74.1,14,6191],['2019-11-19T00:00:00+0530',74.2,74.2,73.96,73.9925,376,6215],['2019-11-20T00:00:00+0530',74.05,74.15,74.05,74.14,29,6235],['2019-11-21T00:00:00+0530',74,74.1025,73.9725,74.0275,15,6230],['2019-11-22T00:00:00+0530',73.9175,74.035,73.9175,74,252,6282],['2019-11-25T00:00:00+0530',73.9,74,73.88,73.9975,21,6274],['2019-11-26T00:00:00+0530',73.9,73.9475,73.745,73.9475,219,6101],['2019-11-27T00:00:00+0530',73.7,73.745,73.48,73.53,71,6043],['2019-11-28T00:00:00+0530',73.3025,73.7525,73.3025,73.7525,40,6053],['2019-11-29T00:00:00+0530',73.8,73.9975,73.8,73.95,289,6021],['2019-12-02T00:00:00+0530',73.8,73.915,73.7675,73.915,48,6041],['2019-12-03T00:00:00+0530',73.8525,73.93,73.71,73.9275,333,5930],['2019-12-04T00:00:00+0530',73.725,73.725,73.725,73.725,5,5935],['2019-12-05T00:00:00+0530',73.73,73.8275,73.55,73.56,47,5916],['2019-12-06T00:00:00+0530',73.56,73.65,73.48,73.53,268,5939],['2019-12-09T00:00:00+0530',73.5575,73.5575,73.3,73.3,187,5769],['2019-12-10T00:00:00+0530',73.3,73.3,73.115,73.18,1382,5405],['2019-12-11T00:00:00+0530',73.1,73.15,73.01,73.15,345,5592],['2019-12-12T00:00:00+0530',72.9175,73.03,72.815,73,181,5652],['2019-12-13T00:00:00+0530',72.6775,73.11,72.6775,73.11,60,5698],['2019-12-16T00:00:00+0530',73.145,73.3,73.13,73.3,87,5679],['2019-12-17T00:00:00+0530',73.1525,73.165,73.14,73.165,69,5691],['2019-12-18T00:00:00+0530',73.305,73.4,73.27,73.285,21,5697],['2019-12-19T00:00:00+0530',73.235,73.45,73.2,73.3125,241,5794],['2019-12-20T00:00:00+0530',73.38,73.43,73.33,73.33,38,5826],['2019-12-23T00:00:00+0530',73.33,73.4,73.33,73.4,28,5854],['2019-12-24T00:00:00+0530',73.4,73.51,73.4,73.4325,390,6239],['2019-12-26T00:00:00+0530',73.4325,73.4325,73.4325,73.4325,4,6242],['2019-12-27T00:00:00+0530',73.52,73.52,73.5,73.5,6,6247],['2019-12-30T00:00:00+0530',73.5,73.5,73.5,73.5,1,6248],['2019-12-31T00:00:00+0530',73.4475,73.5075,73.3025,73.5,1453,6036],['2020-01-01T00:00:00+0530',73.4675,73.48,73.3925,73.405,12,6044],['2020-01-02T00:00:00+0530',73.45,73.45,73.45,73.45,1,6044],['2020-01-03T00:00:00+0530',73.63,73.9325,73.58,73.8975,430,6439],['2020-01-06T00:00:00+0530',74.125,74.22,74.03,74.0975,281,6686],['2020-01-07T00:00:00+0530',73.875,73.9,73.8375,73.8375,6,6686],['2020-01-08T00:00:00+0530',74.1,74.1,73.9775,74.005,18,6695],['2020-01-09T00:00:00+0530',73.55,73.6475,73.35,73.4,495,6951],['2020-01-10T00:00:00+0530',73.2525,73.3975,72.92,73.0025,260,6814],['2020-01-13T00:00:00+0530',72.94,73.0025,72.85,72.8725,1111,6349],['2020-01-14T00:00:00+0530',72.9,72.99,72.845,72.92,121,6358],['2020-01-15T00:00:00+0530',72.945,72.945,72.8875,72.8875,16,6354],['2020-01-16T00:00:00+0530',72.7725,72.9875,72.7725,72.925,88,6371],['2020-01-17T00:00:00+0530',72.94,73.07,72.94,73.07,89,6391],['2020-01-20T00:00:00+0530',73.07,73.0975,73.05,73.0975,26,6391],['2020-01-21T00:00:00+0530',73.1275,73.175,73.1275,73.175,28,6376],['2020-01-22T00:00:00+0530',73.165,73.165,73.1,73.1575,45,6351],['2020-01-23T00:00:00+0530',73.175,73.175,73.1225,73.1225,15,6352],['2020-01-24T00:00:00+0530',73.1,73.135,73.0975,73.135,20,6363],['2020-01-27T00:00:00+0530',73.275,73.3775,73.2325,73.3425,739,6620],['2020-01-28T00:00:00+0530',73.235,73.235,73.135,73.1825,6,6619],['2020-01-29T00:00:00+0530',73.0825,73.1,73.06,73.1,6,6623],['2020-01-30T00:00:00+0530',73.2275,73.455,73.2275,73.32,443,6963],['2020-01-31T00:00:00+0530',73.16,73.2975,73.16,73.2975,4,6967],['2020-02-03T00:00:00+0530',73.47,73.48,73.425,73.48,234,7200],['2020-02-04T00:00:00+0530',73.05,73.1225,72.98,73.1,173,7321],['2020-02-05T00:00:00+0530',73.01,73.0925,73,73.05,43,7320],['2020-02-06T00:00:00+0530',73.05,73.07,72.965,72.965,74,7375],['2020-02-07T00:00:00+0530',73.025,73.18,73,73.1275,1593,8736],['2020-02-10T00:00:00+0530',73.0075,73.1025,72.95,72.95,170,8884],['2020-02-11T00:00:00+0530',72.95,72.995,72.9075,72.9575,30,8890],['2020-02-12T00:00:00+0530',72.945,73.0475,72.9,73.0075,304,9015],['2020-02-13T00:00:00+0530',73.035,73.095,72.9325,72.9325,185,9068],['2020-02-14T00:00:00+0530',73.0175,73.02,72.9275,72.9525,93,8980],['2020-02-17T00:00:00+0530',72.95,72.9925,72.9,72.9,4,8982],['2020-02-18T00:00:00+0530',72.9575,73.045,72.945,73.0425,606,9368],['2020-02-20T00:00:00+0530',73.0425,73.2,73.0425,73.075,807,10088],['2020-02-24T00:00:00+0530',73.3,73.5125,73.2825,73.485,255,10266],['2020-02-25T00:00:00+0530',73.255,73.415,73.255,73.375,409,10277],['2020-02-26T00:00:00+0530',73.3725,73.3725,73.13,73.165,461,10494],['2020-02-27T00:00:00+0530',73.1,73.165,73.03,73.0675,371,10695],['2020-02-28T00:00:00+0530',73.3,73.75,73.275,73.6825,1715,11775],['2020-03-02T00:00:00+0530',73.6,74.32,73.57,74.2125,2295,12204],['2020-03-03T00:00:00+0530',73.9575,74.905,73.9475,74.835,4818,11981],['2020-03-04T00:00:00+0530',74.8,75.2,74.49,74.7975,4605,12682],['2020-03-05T00:00:00+0530',74.74,74.955,74.57,74.7925,629,12541],['2020-03-06T00:00:00+0530',74.9,75.45,74.9,75.225,1364,13162],['2020-03-09T00:00:00+0530',75.5,75.69,75.4,75.56,2453,14348],['2020-03-11T00:00:00+0530',75.4225,75.5,75.05,75.05,830,14159],['2020-03-12T00:00:00+0530',75.3,75.78,75.3,75.6475,517,14374],['2020-03-13T00:00:00+0530',75.86,75.8975,75.32,75.4425,1489,13655],['2020-03-16T00:00:00+0530',75.5,75.8475,75.5,75.7525,2168,15163],['2020-03-17T00:00:00+0530',76,76,75.4,75.8375,839,15136],['2020-03-18T00:00:00+0530',75.5,75.925,75.5,75.86,659,15564],['2020-03-19T00:00:00+0530',76.1,76.95,76.1,76.79,3148,17472],['2020-03-20T00:00:00+0530',76.5,76.945,76.43,76.9075,907,17676],['2020-03-23T00:00:00+0530',78.41,80.49,77.1,78.605,3583,15354],['2020-03-24T00:00:00+0530',78.6,78.6,78.0875,78.1775,3582,12952],['2020-03-26T00:00:00+0530',78.16,78.16,77.25,77.445,1432,12003],['2020-03-27T00:00:00+0530',76.4,77.6575,76.4,77,602,12078],['2020-03-30T00:00:00+0530',77.3,77.3,77.22,77.235,1535,12086],['2020-03-31T00:00:00+0530',77.1,77.1,76.7625,76.96,48,12078],['2020-04-03T00:00:00+0530',77.6875,77.89,77.4375,77.8325,1626,12156],['2020-04-07T00:00:00+0530',77.5325,77.65,77.23,77.41,250,12161],['2020-04-08T00:00:00+0530',77.65,77.9875,77.5,77.95,1046,12945],['2020-04-09T00:00:00+0530',77.5925,78.0975,77.5925,77.9125,383,12967],['2020-04-13T00:00:00+0530',77.7575,77.9,77.61,77.695,127,12871],['2020-04-15T00:00:00+0530',77.515,77.9875,77.355,77.94,451,12912],['2020-04-16T00:00:00+0530',78.07,78.355,77.9675,78.315,3821,13143],['2020-04-17T00:00:00+0530',78.135,78.135,77.695,77.8975,816,12919],['2020-04-20T00:00:00+0530',77.8,78.07,77.8,77.91,98,12845],['2020-04-21T00:00:00+0530',78.0025,78.45,78.0025,78.35,522,13003],['2020-04-22T00:00:00+0530',78.25,78.3475,77.85,77.9225,418,12885],['2020-04-23T00:00:00+0530',77.76,77.8775,77.3,77.4425,783,12765],['2020-04-24T00:00:00+0530',77.5625,77.8,77.5425,77.615,114,12792],['2020-04-27T00:00:00+0530',77.5,77.6125,77.385,77.45,875,13004],['2020-04-28T00:00:00+0530',77.0025,77.6275,77.0025,77.0925,2809,13935],['2020-04-29T00:00:00+0530',77.0975,77.2025,76.745,76.875,2266,14460],['2020-04-30T00:00:00+0530',76.5,76.5425,76.055,76.205,2397,14976],['2020-05-04T00:00:00+0530',76.8475,76.9575,76.7375,76.7825,951,15421],['2020-05-05T00:00:00+0530',76.65,77,76.61,76.8925,888,15869],['2020-05-06T00:00:00+0530',76.86,77.07,76.78,77.0275,2350,16197],['2020-05-08T00:00:00+0530',76.8,76.85,76.47,76.735,1541,16510],['2020-05-11T00:00:00+0530',76.5975,76.9425,76.5975,76.9225,911,17197],['2020-05-12T00:00:00+0530',77.02,77.0625,76.3525,76.405,1136,17155],['2020-05-13T00:00:00+0530',76.1,76.6,76.1,76.42,907,17281],['2020-05-14T00:00:00+0530',76.5175,76.6675,76.4675,76.65,258,17456],['2020-05-15T00:00:00+0530',76.545,76.9,76.5,76.87,429,17588],['2020-05-18T00:00:00+0530',76.785,77.125,76.785,77.025,1305,18406],['2020-05-19T00:00:00+0530',76.9,76.9475,76.6225,76.6625,1959,18281],['2020-05-20T00:00:00+0530',76.81,76.89,76.6025,76.7275,252,18330],['2020-05-21T00:00:00+0530',76.85,76.9725,76.2,76.5375,1416,18511],['2020-05-22T00:00:00+0530',76.6,76.9025,76.57,76.8225,1898,19815],['2020-05-26T00:00:00+0530',76.5525,77.05,76.54,76.57,1225,19462],['2020-05-27T00:00:00+0530',76.5,76.7575,76.445,76.5325,4339,20732],['2020-05-28T00:00:00+0530',76.63,76.735,76.5775,76.6675,1175,21070],['2020-05-29T00:00:00+0530',76.58,76.9475,76.34,76.4325,6501,25883],['2020-06-01T00:00:00+0530',76.35,76.65,75.8,76.385,8012,26696],['2020-06-02T00:00:00+0530',76.5775,76.5775,75.9,75.98,3347,26944],['2020-06-03T00:00:00+0530',75.915,76.35,75.86,76.3325,3494,27714],['2020-06-04T00:00:00+0530',76.3,76.45,76.1675,76.395,3425,27313],['2020-06-05T00:00:00+0530',76.2,76.465,76.1375,76.4325,10022,33806],['2020-06-08T00:00:00+0530',76.3975,76.41,76.19,76.32,2655,33411],['2020-06-09T00:00:00+0530',76.4,76.98,76,76.385,2261,33565],['2020-06-10T00:00:00+0530',76.25,76.3425,76.1775,76.3,1970,33492],['2020-06-11T00:00:00+0530',76.36,76.6,76.355,76.5,4240,35370],['2020-06-12T00:00:00+0530',76.8025,76.84,76.52,76.6025,7011,34789],['2020-06-15T00:00:00+0530',76.7,76.8825,76.6475,76.8425,16829,35723],['2020-06-16T00:00:00+0530',76.65,77.05,76.52,76.8325,9486,37468],['2020-06-17T00:00:00+0530',77.0225,77.1975,76.7025,76.94,6300,38419],['2020-06-18T00:00:00+0530',76.855,76.95,76.81,76.8475,2842,38364],['2020-06-19T00:00:00+0530',76.955,77.02,76.88,76.92,5534,39988],['2020-06-22T00:00:00+0530',76.9025,76.9275,76.7,76.7275,8505,42821],['2020-06-23T00:00:00+0530',76.6,76.6375,76.2,76.265,11667,40982],['2020-06-24T00:00:00+0530',76.24,76.43,76.225,76.275,12367,44173],['2020-06-25T00:00:00+0530',76.42,76.42,76.2025,76.24,17882,52890],['2020-06-26T00:00:00+0530',76.195,76.29,76.0925,76.26,23473,57760],['2020-06-29T00:00:00+0530',76.2725,76.3125,76.13,76.1425,7562,58155],['2020-06-30T00:00:00+0530',76.135,76.25,76.08,76.2325,13310,59079],['2020-07-01T00:00:00+0530',76.1875,76.25,76.1275,76.24,24854,65991],['2020-07-02T00:00:00+0530',76.14,76.14,75.2775,75.3575,33633,65585],['2020-07-03T00:00:00+0530',75.31,75.6175,75.1,75.2775,22377,69309],['2020-07-06T00:00:00+0530',75.395,75.42,75.05,75.225,35321,79490],['2020-07-07T00:00:00+0530',75.25,75.58,75.225,75.4975,46297,91150],['2020-07-08T00:00:00+0530',75.4775,75.685,75.42,75.635,11598,91557],['2020-07-09T00:00:00+0530',75.6,75.655,75.48,75.5675,5539,92235],['2020-07-10T00:00:00+0530',75.64,75.9,75.605,75.83,28309,97880],['2020-07-13T00:00:00+0530',75.84,75.84,75.6525,75.7275,36406,97913],['2020-07-14T00:00:00+0530',75.8275,76.065,75.825,75.9675,19234,99439],['2020-07-15T00:00:00+0530',75.9125,75.9125,75.6425,75.685,17049,100616],['2020-07-16T00:00:00+0530',75.75,75.83,75.69,75.755,6662,102024],['2020-07-17T00:00:00+0530',75.7325,75.7875,75.495,75.5125,16225,101378],['2020-07-20T00:00:00+0530',75.5,75.55,75.2675,75.2925,13335,101458],['2020-07-21T00:00:00+0530',75.2125,75.3725,75.125,75.1475,47205,119902],['2020-07-22T00:00:00+0530',75.17,75.365,75.0325,75.08,41466,126585],['2020-07-23T00:00:00+0530',75.1075,75.34,75.0775,75.3,32915,139875],['2020-07-24T00:00:00+0530',75.05,75.44,75.05,75.3075,14831,140892],['2020-07-27T00:00:00+0530',75.1,75.34,75.055,75.2575,55310,162354],['2020-07-28T00:00:00+0530',75.245,75.33,75.1525,75.2775,31144,168127],['2020-07-29T00:00:00+0530',75.37,75.43,75.1475,75.17,126549,206491],['2020-07-30T00:00:00+0530',75.29,75.34,75.215,75.3,109306,225775],['2020-07-31T00:00:00+0530',75.2,75.2975,75.09,75.23,183571,253350],['2020-08-03T00:00:00+0530',75.33,75.7,75.2775,75.655,148285,280062],['2020-08-04T00:00:00+0530',75.48,75.61,75.37,75.4975,111210,290633],['2020-08-05T00:00:00+0530',75.3525,75.42,75.1825,75.2325,108929,297488],['2020-08-06T00:00:00+0530',75.2275,75.3675,75.14,75.33,132626,313219],['2020-08-07T00:00:00+0530',75.36,75.45,75.2625,75.325,122001,329621],['2020-08-10T00:00:00+0530',75.3775,75.39,75.205,75.2925,73255,326435],['2020-08-11T00:00:00+0530',75.22,75.23,74.9275,75.005,180648,343872],['2020-08-12T00:00:00+0530',75.015,75.26,75.015,75.1225,161024,376168],['2020-08-13T00:00:00+0530',75.19,75.23,75.085,75.135,112753,409854],['2020-08-14T00:00:00+0530',75.195,75.2775,75.055,75.2275,169738,474566],['2020-08-17T00:00:00+0530',75.1725,75.205,75.0875,75.1525,119293,476074],['2020-08-18T00:00:00+0530',75.08,75.17,74.93,74.9525,222036,498565],['2020-08-19T00:00:00+0530',74.9025,75.1975,74.9025,75.1225,251034,551327],['2020-08-20T00:00:00+0530',75.2,75.3925,75.15,75.38,312478,664830],['2020-08-21T00:00:00+0530',75.25,75.3275,75.1,75.14,251862,667885],['2020-08-24T00:00:00+0530',75.18,75.205,74.255,74.385,846923,796709],['2020-08-25T00:00:00+0530',74.3575,74.75,74.2925,74.48,801351,948398],['2020-08-26T00:00:00+0530',74.48,74.6825,74.455,74.485,909472,1215169],['2020-08-27T00:00:00+0530',74.455,74.5875,74.0225,74.1325,3182649,1635606],['2020-08-28T00:00:00+0530',74.0725,74.095,73.4575,73.505,3364518,1601110],['2020-08-31T00:00:00+0530',73.46,73.9075,73.22,73.4425,3313827,1433028],['2020-09-01T00:00:00+0530',73.4675,73.5,72.92,73.16,2685109,1476325],['2020-09-02T00:00:00+0530',73.19,73.3975,73.0875,73.35,2300483,1461494],['2020-09-03T00:00:00+0530',73.36,73.7,73.32,73.6775,2153995,1433734],['2020-09-04T00:00:00+0530',73.72,73.78,73.1725,73.3025,2447524,1474382],['2020-09-07T00:00:00+0530',73.24,73.6425,73.1725,73.595,1857901,1458081]]}";

            dynamic obj = Newtonsoft.Json.JsonConvert.DeserializeObject(response);
            //dynamic candles = obj["candles"];
            dynamic candles = @"{[['2020-09-17T20:00:00+0530', 2993, 2999, 2993, 2998, 293, 3729 ],
      [ '2020-09-17T20:01:00+0530', 2998, 2998, 2994, 2995, 93, 3737 ],
      [ '2020-09-17T20:02:00+0530', 2995, 3000, 2995, 2995, 148, 3767 ],
      [ '2020-09-17T20:03:00+0530', 2994, 2997, 2992, 2997, 74, 3772 ],
      [ '2020-09-17T20:04:00+0530', 2997, 3000, 2995, 2999, 84, 3795 ],
      [ '2020-09-17T20:05:00+0530', 3000, 3003, 2995, 2995, 198, 3816 ],
      [ '2020-09-17T20:06:00+0530', 2995, 3003, 2994, 3002, 155, 3858 ],
      [ '2020-09-17T20:07:00+0530', 3002, 3004, 2999, 3003, 351, 3876 ],
      [ '2020-09-17T20:08:00+0530', 3003, 3004, 2998, 2999, 265, 3961 ],
      [ '2020-09-17T20:09:00+0530', 2999, 3001, 2998, 3001, 79, 3978 ],
      [ '2020-09-17T20:10:00+0530', 2999, 3004, 2999, 3003, 251, 4080 ],
      [ '2020-09-17T20:11:00+0530', 3003, 3005, 3002, 3003, 76, 4102 ],
      [ '2020-09-17T20:12:00+0530', 3004, 3010, 3003, 3010, 539, 3918 ],
      [ '2020-09-17T20:13:00+0530', 3009, 3011, 3007, 3011, 280, 3914 ],
      [ '2020-09-17T20:14:00+0530', 3011, 3011, 3007, 3008, 146, 3999 ],
      [ '2020-09-17T20:15:00+0530', 3008, 3014, 3008, 3010, 324, 3959 ],
      [ '2020-09-17T20:16:00+0530', 3012, 3014, 3010, 3011, 311, 3926 ],
      [ '2020-09-17T20:17:00+0530', 3011, 3011, 3006, 3008, 309, 3874 ],
      [ '2020-09-17T20:18:00+0530', 3008, 3009, 3005, 3005, 319, 3971 ],
      [ '2020-09-17T20:19:00+0530', 3005, 3007, 3004, 3006, 240, 3997 ],
      [ '2020-09-17T20:20:00+0530', 3008, 3013, 3006, 3010, 260, 3889 ],
      [ '2020-09-17T20:21:00+0530', 3009, 3011, 3001, 3002, 383, 3985 ],
      [ '2020-09-17T20:22:00+0530', 3001, 3005, 3000, 3004, 197, 3882 ],
      [ '2020-09-17T20:23:00+0530', 3004, 3005, 3001, 3001, 136, 3894 ],
      [ '2020-09-17T20:24:00+0530', 3001, 3004, 3001, 3002, 97, 3888 ],
      [ '2020-09-17T20:25:00+0530', 3001, 3003, 3000, 3001, 125, 3853 ],
      [ '2020-09-17T20:26:00+0530', 3001, 3004, 3000, 3003, 86, 3831 ],
      [ '2020-09-17T20:27:00+0530', 3004, 3008, 3004, 3006, 119, 3806 ],
      [ '2020-09-17T20:28:00+0530', 3006, 3006, 3000, 3001, 98, 3860 ],
      [ '2020-09-17T20:29:00+0530', 3001, 3003, 2999, 3000, 128, 3869 ],
      [ '2020-09-17T20:30:00+0530', 3000, 3002, 3000, 3000, 70, 3854 ],
      [ '2020-09-17T20:31:00+0530', 3001, 3003, 2997, 2998, 100, 3873 ],
      [ '2020-09-17T20:32:00+0530', 2999, 3007, 2999, 3006, 172, 3807 ],
      [ '2020-09-17T20:33:00+0530', 3006, 3008, 3004, 3008, 191, 3864 ],
      [ '2020-09-17T20:34:00+0530', 3008, 3008, 3006, 3006, 86, 3879 ],
      [ '2020-09-17T20:35:00+0530', 3006, 3010, 3006, 3009, 292, 3754 ],
      [ '2020-09-17T20:36:00+0530', 3009, 3016, 3009, 3015, 336, 3671 ],
      [ '2020-09-17T20:37:00+0530', 3015, 3015, 3010, 3011, 132, 3668 ],
      [ '2020-09-17T20:38:00+0530', 3010, 3015, 3010, 3013, 60, 3664 ],
      [ '2020-09-17T20:39:00+0530', 3013, 3016, 3013, 3015, 91, 3651 ],
      [ '2020-09-17T20:40:00+0530', 3015, 3019, 3014, 3017, 199, 3627 ],
      [ '2020-09-17T20:41:00+0530', 3017, 3023, 3017, 3023, 513, 3519 ],
      [ '2020-09-17T20:42:00+0530', 3023, 3027, 3020, 3025, 680, 3352 ],
      [ '2020-09-17T20:43:00+0530', 3025, 3030, 3024, 3029, 299, 3238 ],
      [ '2020-09-17T20:44:00+0530', 3028, 3033, 3028, 3032, 392, 3261 ],
      [ '2020-09-17T20:45:00+0530', 3032, 3033, 3026, 3029, 276, 3209 ],
      [ '2020-09-17T20:46:00+0530', 3029, 3029, 3023, 3023, 150, 3231 ],
      [ '2020-09-17T20:47:00+0530', 3023, 3027, 3022, 3026, 130, 3253 ],
      [ '2020-09-17T20:48:00+0530', 3026, 3026, 3021, 3021, 92, 3238 ],
      [ '2020-09-17T20:49:00+0530', 3021, 3023, 3020, 3020, 116, 3258 ],
      [ '2020-09-17T20:50:00+0530', 3020, 3025, 3020, 3024, 119, 3301 ],
      [ '2020-09-17T20:51:00+0530', 3024, 3025, 3022, 3023, 26, 3310 ],
      [ '2020-09-17T20:52:00+0530', 3024, 3029, 3023, 3028, 74, 3319 ],
      [ '2020-09-17T20:53:00+0530', 3027, 3030, 3027, 3028, 59, 3328 ],
      [ '2020-09-17T20:54:00+0530', 3028, 3029, 3023, 3025, 91, 3340 ],
      [ '2020-09-17T20:55:00+0530', 3024, 3025, 3019, 3020, 80, 3340 ],
      [ '2020-09-17T20:56:00+0530', 3020, 3022, 3018, 3021, 135, 3374 ],
      [ '2020-09-17T20:57:00+0530', 3021, 3021, 3016, 3017, 90, 3373 ],
      [ '2020-09-17T20:58:00+0530', 3016, 3021, 3016, 3016, 73, 3368 ],
      [ '2020-09-17T20:59:00+0530', 3016, 3019, 3013, 3017, 135, 3368 ],
      [ '2020-09-17T21:00:00+0530', 3017, 3023, 3016, 3023, 92, 3382 ],
      [ '2020-09-17T21:01:00+0530', 3023, 3023, 3020, 3021, 36, 3386 ],
      [ '2020-09-17T21:02:00+0530', 3021, 3022, 3021, 3022, 27, 3382 ],
      [ '2020-09-17T21:03:00+0530', 3022, 3022, 3020, 3022, 30, 3389 ],
      [ '2020-09-17T21:04:00+0530', 3022, 3022, 3020, 3021, 20, 3401 ],
      [ '2020-09-17T21:05:00+0530', 3021, 3021, 3013, 3015, 157, 3476 ],
      [ '2020-09-17T21:06:00+0530', 3015, 3015, 3007, 3011, 401, 3300 ],
      [ '2020-09-17T21:07:00+0530', 3011, 3012, 3006, 3006, 99, 3296 ],
      [ '2020-09-17T21:08:00+0530', 3006, 3007, 3004, 3007, 198, 3256 ],
      [ '2020-09-17T21:09:00+0530', 3007, 3010, 3005, 3005, 130, 3229 ],
      [ '2020-09-17T21:10:00+0530', 3006, 3012, 3006, 3011, 75, 3215 ],
      [ '2020-09-17T21:11:00+0530', 3011, 3012, 3010, 3012, 65, 3226 ],
      [ '2020-09-17T21:12:00+0530', 3012, 3012, 3008, 3010, 45, 3246 ],
      [ '2020-09-17T21:13:00+0530', 3010, 3016, 3010, 3015, 74, 3236 ],
      [ '2020-09-17T21:14:00+0530', 3015, 3018, 3015, 3016, 141, 3231 ],
      [ '2020-09-17T21:15:00+0530', 3016, 3018, 3015, 3015, 130, 3295 ],
      [ '2020-09-17T21:16:00+0530', 3015, 3017, 3015, 3017, 39, 3292 ],
      [ '2020-09-17T21:17:00+0530', 3017, 3017, 3015, 3015, 28, 3299 ],
      [ '2020-09-17T21:18:00+0530', 3013, 3015, 3011, 3013, 30, 3294 ],
      [ '2020-09-17T21:19:00+0530', 3013, 3013, 3010, 3012, 28, 3300 ],
      [ '2020-09-17T21:20:00+0530', 3012, 3015, 3009, 3009, 38, 3298 ],
      [ '2020-09-17T21:21:00+0530', 3009, 3009, 3007, 3009, 41, 3303 ],
      [ '2020-09-17T21:22:00+0530', 3009, 3009, 3007, 3008, 29, 3318 ],
      [ '2020-09-17T21:23:00+0530', 3008, 3012, 3007, 3011, 111, 3313 ],
      [ '2020-09-17T21:24:00+0530', 3011, 3012, 3009, 3009, 29, 3334 ],
      [ '2020-09-17T21:25:00+0530', 3009, 3011, 3009, 3010, 14, 3333 ],
      [ '2020-09-17T21:26:00+0530', 3010, 3010, 3008, 3009, 24, 3336 ],
      [ '2020-09-17T21:27:00+0530', 3009, 3012, 3009, 3012, 24, 3326 ],
      [ '2020-09-17T21:28:00+0530', 3012, 3014, 3012, 3013, 42, 3341 ],
      [ '2020-09-17T21:29:00+0530', 3013, 3013, 3009, 3009, 33, 3350 ],
      [ '2020-09-17T21:30:00+0530', 3009, 3013, 3008, 3012, 29, 3343 ],
      [ '2020-09-17T21:31:00+0530', 3012, 3015, 3011, 3014, 42, 3328 ],
      [ '2020-09-17T21:32:00+0530', 3014, 3017, 3014, 3016, 127, 3259 ],
      [ '2020-09-17T21:33:00+0530', 3016, 3016, 3014, 3016, 102, 3317 ],
      [ '2020-09-17T21:34:00+0530', 3016, 3017, 3015, 3017, 34, 3320 ],
      [ '2020-09-17T21:35:00+0530', 3017, 3022, 3017, 3021, 190, 3253 ],
      [ '2020-09-17T21:36:00+0530', 3021, 3022, 3020, 3022, 83, 3265 ],
      [ '2020-09-17T21:37:00+0530', 3022, 3022, 3014, 3014, 63, 3291 ],
      [ '2020-09-17T21:38:00+0530', 3014, 3016, 3014, 3015, 29, 3285 ],
      [ '2020-09-17T21:39:00+0530', 3015, 3017, 3014, 3016, 35, 3293 ],
      [ '2020-09-17T21:40:00+0530', 3016, 3018, 3016, 3016, 35, 3293 ],
      [ '2020-09-17T21:41:00+0530', 3016, 3016, 3016, 3016, 2, 3292 ]]}";
            List<Candle> cans = new List<Candle>();
            foreach(dynamic candle in candles)
            {
                dynamic fields = candle.ToString().Trim('[').Trim('[').Split(',');
                int index = 0;
                Candle can = new Candle();
                foreach (dynamic field in fields)
                {                    
                    if (index == 0)
                    {
                        string dateString = field.Trim('\r').Trim('\n').ToString();
                        dateString = dateString.Substring(3, dateString.Length - 4);
                        can.TimeStamp = DateTime.Parse(dateString);                       
                    }
                    if(index == 1)
                        can.Open = Decimal.Parse(field);
                    if (index == 2)
                        can.High = Decimal.Parse(field);
                    if (index == 3)
                        can.Low = Decimal.Parse(field);
                    if (index == 4)
                        can.Close = Decimal.Parse(field);
                    index++;
                }
                cans.Add(can);
            }
            return cans;
        }
    }

    class Data
    {
        public ChartData[] Candles { get; set; }
    }
    class ChartData
    {
        public List<Object> Fields { get; set; }
    }
}
